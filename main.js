(()=>{"use strict";var e,t=function(e){return"url"===e.type||/^[a-zA-Zа-яА-ЯёЁ\s\,\.-]+$/.test(e.value)},o=function(e,t,o){var r=e.querySelector(".".concat(t.id,"-error"));t.classList.add("popup__input_type_error"),r.textContent=o,r.classList.add("popup__input-error_active")},r=function(e,t){var o=e.querySelector(".".concat(t.id,"-error"));t.classList.remove("popup__input_type_error"),o.classList.remove("popup__input-error_active"),o.textContent=""},n=function(e,o){!function(e){return e.some((function(e){return!e.validity.valid||!t(e)}))}(e)?(o.disabled=!1,o.classList.remove("popup__button_disabled")):(o.disabled=!0,o.classList.add("popup__button_disabled"))},c=function(e,t){var o=Array.from(e.querySelectorAll(t.inputSelector)),n=e.querySelector(t.submitButtonSelector);o.forEach((function(t){r(e,t)})),n.disabled=!0,n.classList.add(t.inactiveButtonClass)},a=function(e){e.classList.remove("popup_is-opened","popup_is-animated"),document.removeEventListener("keydown",l),e.removeEventListener("click",u)},i=function(e){e.classList.add("popup_is-opened","popup_is-animated"),document.addEventListener("keydown",l),e.addEventListener("click",u)},u=function(e){(e.target===e.currentTarget||e.target.classList.contains("popup__close"))&&a(e.currentTarget)},l=function(e){"Escape"===e.key&&a(document.querySelector(".popup_is-opened"))},s=document.querySelector(".popup_type_image"),p=s.querySelector(".popup__image"),d=s.querySelector(".popup__caption"),f=function(e,t){p.src=e,d.alt=t,d.textContent=t,i(s)},_=function(){return fetch("https://nomoreparties.co/v1/wff-cohort-3/users/me ",{method:"GET",headers:{authorization:"527ccf5e-48ed-459d-9003-516016edecdb"}}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))})).then((function(e){var t=document.querySelector(".profile__title"),o=document.querySelector(".profile__description"),r=document.querySelector(".profile__image");return t.textContent=e.name,o.textContent=e.about,r.src=e.avatar,r.alt=e.name,e._id})).catch((function(e){console.error("Ошибка GET PROFILE :",e)}))},m=document.querySelector(".places__list"),v=document.querySelector("#card-template").content,h=function(e,t,o,r,n,c,a){var i=v.querySelector(".card").cloneNode(!0),u=i.querySelector(".card__delete-button"),l=i.querySelector(".card__like-button"),s=i.querySelector(".card__image"),p=i.querySelector(".card__like-count");i.querySelector(".card__image").src=e,i.querySelector(".card__title").textContent=t,i.querySelector(".card__image").alt=t,u.style.display=c?"block":"none";var d="true"===localStorage.getItem("like-".concat(a));return l.classList.toggle("card__like-button_is-active",d),p.textContent=n,l.addEventListener("click",(function(){S(a,l,p)})),u.addEventListener("click",(function(e){confirm("Вы уверены, что хотите удалить эту карточку?")&&o(e,a)})),s.addEventListener("click",(function(){return r(e,t)})),i},y=function(e,t){var o=e.target.parentElement;(function(e){return fetch("https://nomoreparties.co/v1/wff-cohort-3/cards/".concat(e),{method:"DELETE",headers:{authorization:"527ccf5e-48ed-459d-9003-516016edecdb"}}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))})).catch((function(e){console.error("Ошибка removeCard:",e)}))})(t).then((function(){o.remove()})).catch((function(e){console.error(e)}))},S=function(e,t,o){var r=t.classList.contains("card__like-button_is-active");(function(e,t){var o=t?"DELETE":"PUT";return console.log("Toggle like request:",e,o,t),fetch("https://nomoreparties.co/v1/wff-cohort-3/cards/likes/".concat(e),{method:o,headers:{authorization:"527ccf5e-48ed-459d-9003-516016edecdb"}}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))})).catch((function(e){console.error("Ошибка toggleLike:",e)}))})(e,r).then((function(n){var c=JSON.parse(localStorage.getItem("likedCards"))||{};c[e]=n.likes.length,localStorage.setItem("likedCards",JSON.stringify(c)),o.textContent=c[e],t.classList.toggle("card__like-button_is-active",!r),localStorage.setItem("like-".concat(e),String(!r)),console.log("Пользователи, лайкнувшие карточку:",n.likes)})).catch((function(e){console.error(e)}))},b=document.querySelector(".popup_type_edit"),g=document.querySelector(".popup_type_new-card"),C=document.querySelector(".profile__edit-button"),k=document.querySelector(".profile__add-button"),E=(document.querySelectorAll(".popup__close"),document.querySelector(".profile__image-overlay")),q=document.querySelector(".profile__image"),L=document.querySelector(".popup_type_avatar"),j={formSelector:".popup__form_edit",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__input-error_active"},w={formSelector:".popup__form_new-card",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__input-error_active"},x={formSelector:".avatar-form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__input-error_active"},A=document.forms["new-place"],T=A.elements["place-name"],P=A.elements.link,B=A.elements["new-card-button"],O=document.forms["edit-profile"],I=O.elements.name,z=O.elements.description,N=O.elements["profile-button"],D=document.querySelector(".profile__title"),J=document.querySelector(".profile__description"),U=document.forms["avatar-edit"],$=U.elements.avatar,R=U.elements["avatar-button"];function G(e,t){(null==t||t>e.length)&&(t=e.length);for(var o=0,r=new Array(t);o<t;o++)r[o]=e[o];return r}e={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__input-error_active"},Array.from(document.querySelectorAll(e.formSelector)).forEach((function(c){c.addEventListener("submit",(function(e){e.preventDefault()}));var a=Array.from(c.querySelectorAll(e.inputSelector)),i=c.querySelector(e.submitButtonSelector);n(a,i),a.forEach((function(e){e.addEventListener("input",(function(){(function(e,n){var c;n.validity.valid?"url"!==n.type||(c=n.value,/^(https?|ftp):\/\/[^\s/$.?#].[^\s]*$/.test(decodeURIComponent(c)))?"link"!==n.name||function(e){return/\.(jpg|jpeg|png|gif)$/i.test(e)}(n.value)?t(n)?r(e,n):o(e,n,"Разрешены только латинские, кириллические буквы, знаки дефиса и пробелы"):o(e,n,"Введите корректный URL изображения"):o(e,n,"Введите корректный URL"):o(e,n,n.validationMessage)})(c,e),n(a,i)}))}))})),Promise.all([_(),fetch("https://nomoreparties.co/v1/wff-cohort-3/cards  ",{method:"GET",headers:{authorization:"527ccf5e-48ed-459d-9003-516016edecdb"}}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))})).catch((function(e){console.error("Ошибка getInitialCards:",e)}))]).then((function(e){var t,o,r=(o=2,function(e){if(Array.isArray(e))return e}(t=e)||function(e,t){var o=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=o){var r,n,c,a,i=[],u=!0,l=!1;try{if(c=(o=o.call(e)).next,0===t){if(Object(o)!==o)return;u=!1}else for(;!(u=(r=c.call(o)).done)&&(i.push(r.value),i.length!==t);u=!0);}catch(e){l=!0,n=e}finally{try{if(!u&&null!=o.return&&(a=o.return(),Object(a)!==a))return}finally{if(l)throw n}}return i}}(t,o)||function(e,t){if(e){if("string"==typeof e)return G(e,t);var o=Object.prototype.toString.call(e).slice(8,-1);return"Object"===o&&e.constructor&&(o=e.constructor.name),"Map"===o||"Set"===o?Array.from(e):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?G(e,t):void 0}}(t,o)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),n=r[0];r[1].forEach((function(e){var t,o=e.link,r=e.name,c=e.likes,a=e._id,i=e.owner._id==n;t=h(o,r,y,f,c.length,i,a),m.append(t)}))})).catch((function(e){console.error("Fetch error:",e)})),C.addEventListener("click",(function(){return c(O,j),I.value=D.textContent,z.value=J.textContent,void i(b)})),k.addEventListener("click",(function(){return c(g,w),void i(g)})),E.addEventListener("click",(function(){return c(U,x),void i(L)})),O.addEventListener("submit",(function(e){e.preventDefault();var t,o=I.value,r=z.value;N.textContent="Сохранение...",(t={name:o,about:r},fetch("https://nomoreparties.co/v1/wff-cohort-3/users/me ",{method:"PATCH",headers:{authorization:"527ccf5e-48ed-459d-9003-516016edecdb","Content-Type":"application/json"},body:JSON.stringify({name:t.name,about:t.about})}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))})).catch((function(e){console.error("Ошибка patchEdi:",e)}))).then((function(e){return D.textContent=e.name,J.textContent=e.about,a(b),_()})).catch((function(e){console.error("Patch edit error:",e)})).finally((function(){N.textContent="Сохранить"}))})),A.addEventListener("submit",(function(e){var t;B.textContent="Сохранение...",e.preventDefault(),(t={name:T.value,link:P.value},fetch("https://nomoreparties.co/v1/wff-cohort-3/cards",{method:"POST",headers:{authorization:"527ccf5e-48ed-459d-9003-516016edecdb","Content-Type":"application/json"},body:JSON.stringify({name:t.name,link:t.link})}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))})).catch((function(e){console.error("Ошибка postCards:",e)}))).then((function(e){var t=e.link,o=e.name,r=e._id,n=h(t,o,y,f,0,!0,r);m.prepend(n),A.reset(),a(g),c(A,w)})).catch((function(e){console.error("Error posting new card:",e)})).finally((function(){B.textContent="Сохранить"}))})),U.addEventListener("submit",(function(e){e.preventDefault();var t=$.value;R.textContent="Сохранение...",function(e){return fetch("https://nomoreparties.co/v1/wff-cohort-3/users/me/avatar",{method:"PATCH",headers:{authorization:"527ccf5e-48ed-459d-9003-516016edecdb","Content-Type":"application/json"},body:JSON.stringify({avatar:e})}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))})).catch((function(e){console.error("Ошибка patchNewAvatar:",e)}))}(t).then((function(e){q.src=e.avatar,q.alt=e.name,U.reset(),a(L)})).catch((function(e){console.error("Error updating avatar:",e)})).finally((function(){R.textContent="Сохранить"}))}))})();